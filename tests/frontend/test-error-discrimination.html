<!DOCTYPE html>
<html>
<head>
    <title>Error Discrimination Test</title>
    <style>
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .info { color: #666; font-style: italic; }
        table { border-collapse: collapse; margin: 1em 0; }
        th, td { border: 1px solid #ccc; padding: 6px 12px; text-align: left; }
        th { background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>Error Discrimination Test</h1>
    <p class="info">
        Tests the <code>isTokenExpired</code> detection logic used in
        <code>forms.js</code> and <code>formioService.js</code>.<br>
        Based on actual Form.io CE v4.6.0 <code>tokenHandler.js</code> responses.
    </p>

    <table>
        <thead><tr><th>Ref</th><th>Server Response</th><th>Expected</th><th>Result</th></tr></thead>
        <tbody id="results"></tbody>
    </table>

    <div id="explanation"></div>

    <script>
        /**
         * Mirror of the detection logic in forms.js / formioService.js.
         * Form.io CE returns:
         *   440  "Token Expired"   — expired JWT
         *   400  "Bad Token"       — malformed / tampered JWT
         * All other 4xx codes (401, 403) are permission / access errors
         * and must NOT trigger a forced logout.
         */
        function isTokenExpired(status, message) {
            return (
                status === 440 ||
                (status === 400 && /bad token/i.test(message)) ||
                /token.*expir|expired.*token/i.test(message)
            );
        }

        // ---- Test cases ----
        const tests = [
            // Form.io CE actual responses
            { status: 440, msg: 'Token Expired',       expect: true,  label: 'CE 440 Token Expired' },
            { status: 400, msg: 'Bad Token',            expect: true,  label: 'CE 400 Bad Token' },

            // Permission / access errors — must NOT trigger logout
            { status: 401, msg: 'Unauthorized',         expect: false, label: '401 Unauthorized (permission)' },
            { status: 403, msg: 'Access denied',        expect: false, label: '403 Access denied' },
            { status: 401, msg: 'User does not have required role', expect: false, label: '401 Role-based denial' },

            // Other errors — must NOT trigger logout
            { status: 404, msg: 'Not found',            expect: false, label: '404 Not found' },
            { status: 500, msg: 'Internal server error',expect: false, label: '500 Server error' },
            { status: 400, msg: 'Validation failed',    expect: false, label: '400 Validation (not token)' },

            // Edge: message-only fallback (no status match)
            { status: 0,   msg: 'Token Expired',        expect: true,  label: 'Message-only "Token Expired"' },
            { status: 0,   msg: 'Something else',       expect: false, label: 'Message-only unrelated' },
        ];

        const tbody = document.getElementById('results');
        let passed = 0;

        tests.forEach((t, i) => {
            const actual = isTokenExpired(t.status, t.msg);
            const ok = actual === t.expect;
            if (ok) passed++;
            const expectLabel = t.expect ? 'Token expired → login' : 'Normal error';
            tbody.innerHTML += `<tr>
                <td>${i + 1}</td>
                <td><code>${t.status}</code> "${t.msg}" — ${t.label}</td>
                <td>${expectLabel}</td>
                <td class="${ok ? 'pass' : 'fail'}">${ok ? 'PASS' : 'FAIL'}</td>
            </tr>`;
        });

        tbody.innerHTML += `<tr>
            <td colspan="3"><strong>Total</strong></td>
            <td class="${passed === tests.length ? 'pass' : 'fail'}">${passed}/${tests.length}</td>
        </tr>`;

        document.getElementById('explanation').innerHTML = `
            <h2>Form.io CE Token Handler Reference</h2>
            <table>
                <tr><th>Scenario</th><th>HTTP Status</th><th>Body</th><th>Our Action</th></tr>
                <tr><td>Expired JWT</td><td><code>440</code></td><td>"Token Expired"</td><td>Clear token → show login</td></tr>
                <tr><td>Malformed JWT</td><td><code>400</code></td><td>"Bad Token"</td><td>Clear token → show login</td></tr>
                <tr><td>No token</td><td>—</td><td>Falls through to anonymous</td><td>initSession shows login</td></tr>
                <tr><td>Permission denied</td><td><code>401</code> / <code>403</code></td><td>Varies</td><td>Show error, keep session</td></tr>
            </table>
            <p class="info">Source: <code>formio/formio/src/middleware/tokenHandler.js</code></p>
        `;
    </script>
</body>
</html>
